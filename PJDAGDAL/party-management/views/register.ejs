<%- include('partials/head', { title: 'تسجيل' }) %>
<%- include('partials/header') %>

  <style>
    /* Register specific styles */
    .auth-wrapper { display:flex; align-items:center; justify-content:center; height:70vh; }
    .card { background:white; padding:24px; border-radius:8px; box-shadow:0 6px 18px rgba(0,0,0,0.08); width:360px }
    label { display:block; margin-top:12px; font-size:14px }
    input { width:100%; padding:8px; margin-top:6px; box-sizing:border-box }
    button { margin-top:16px; width:100%; padding:10px; background:#0b71ff; color:white; border:none; border-radius:4px }
    .msg { margin-top:12px; color:#c00 }
  </style>

  <div class="auth-wrapper">
    <div class="card">
  <h2>إنشاء حساب</h2>
      <form id="registerForm">
        <label for="username">اسم المستخدم</label>
        <input id="username" name="username" required />

        <label for="password">كلمة المرور</label>
        <input id="password" name="password" type="password" required />

        <label for="name">الاسم الكامل (اختياري)</label>
        <input id="name" name="name" />

        <label for="email">البريد الإلكتروني (اختياري)</label>
        <input id="email" name="email" type="email" />

        <button type="submit">تسجيل</button>
      </form>
      <div class="msg" id="msg"></div>
      <p style="margin-top:12px">هل لديك حساب؟ <a href="/login">تسجيل الدخول</a></p>
    </div>
  </div>

  <script>
    const form = document.getElementById('registerForm');
    const msg = document.getElementById('msg');
    const submitBtn = form.querySelector('button[type=submit]');

    // Check whether registration is allowed before enabling form
    (async function(){
      try{
        const resp = await safeFetchJson('/api/auth/register-allowed', { credentials: 'same-origin' });
        if (!resp.ok) {
          msg.textContent = 'Unable to check registration status';
          submitBtn.disabled = true;
          return;
        }
        const data = resp.data;
        if (!data || !data.allowed) {
          msg.textContent = 'التسجيل مغلق — اطلب من مسؤول إنشاء حساب لك.';
          submitBtn.disabled = true;
        }
      } catch (err) {
        msg.textContent = 'خطأ بالاتصال';
        submitBtn.disabled = true;
      }
    })();
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      msg.textContent = '';
      const username = document.getElementById('username').value;
      const password = document.getElementById('password').value;
      const name = document.getElementById('name').value;
      const email = document.getElementById('email').value;
      try {
        const resp = await safeFetchJson('/api/auth/register', {
          method: 'POST',
          credentials: 'same-origin',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, password, name, email })
        });
        const data = resp.data;
        if (!resp.ok) {
          msg.textContent = data && data.message ? data.message : JSON.stringify(data);
          return;
        }
        // store token for later requests
        if (data && data.token) localStorage.setItem('token', data.token);
        // redirect to dashboard
        window.location.href = '/';
      } catch (err) {
        msg.textContent = err.message || 'Network error';
      }
    });
  </script>

<%- include('partials/footer') %>
